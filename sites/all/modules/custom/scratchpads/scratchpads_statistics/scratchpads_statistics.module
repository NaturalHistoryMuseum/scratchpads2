<?php

/**
 * Implements hook_cron().
 */
function scratchpads_statistics_cron(){
  module_load_include('cron.inc', 'scratchpads_statistics');
  _scratchpads_statistics_cron();
}

/**
 * Implements hook_menu().
 */
function scratchpads_statistics_menu(){
  return array(
    'stats' => array(
      'title' => 'Scratchpad statistics',
      'description' => 'Display statistics related to the content created on this site.',
      'page callback' => 'scratchpads_statistics_stats_page',
      'access arguments' => array(
        'access content'
      ),
      'file' => 'scratchpads_statistics.pages.inc',
      'type' => MENU_SUGGESTED_ITEM
    ),
    'stats.json' => array(
      'title' => 'Scratchpad statistics (JSON)',
      'description' => 'Allow a sites statistics to be accessed externally for aggregation by the <a href="http://scratchpads.eu">http://scratchpads.eu</a> site.',
      'page callback' => 'scratchpads_statistics_stats_page_json',
      'delivery callback' => 'json_deliver',
      'access callback' => 'scratchpads_statistics_access',
      'file' => 'scratchpads_statistics.pages.inc',
      'type' => MENU_SUGGESTED_ITEM
    ),
    'admin/config/search/scratchpads-statistics' => array(
      'title' => 'Scratchpads statistics',
      'description' => 'Set the password hash required to access data',
      'page callback' => 'drupal_get_form',
      'page arguments' => array(
        'scratchapds_statistics_config_page'
      ),
      'access arguments' => array(
        'administer scratchpads statistics'
      ),
      'file' => 'scratchpads_statistics.pages.inc',
      'type' => MENU_NORMAL_ITEM
    )
  );
}

/**
 * Implements hook_user_login().
 */
function scratchpads_statistics_user_login(&$edit, $account){
  // Check to see if we already have this user's details.
  $row = db_select('scratchpads_statistics_user', 'u')->fields('u')->condition('email', $account->mail)->execute()->fetch();
  // Stop if we already have the data.
  if($row && $row->latitude){return;}
  // We're here, we need to save the data.
  $name = $account->name;
  $country = NULL;
  $latitude = NULL;
  $longitude = NULL;
  if(@isset($account->field_user_family_name[LANGUAGE_NONE][0]['value']) && isset($account->field_user_given_names[LANGUAGE_NONE][0]['value'])){
    $name = trim($account->field_user_given_names[LANGUAGE_NONE][0]['value'] . ' ' . $account->field_user_family_name[LANGUAGE_NONE][0]['value']);
  }
  if(@isset($account->field_user_country[LANGUAGE_NONE][0]['iso2'])){
    $country = $account->field_user_country[LANGUAGE_NONE][0]['iso2'];
  }
  // Do a GeoIP lookup on the remote hostname.
  $data = file_get_contents('http://freegeoip.net/json/' . $_SERVER['REMOTE_ADDR']);
  if($data){
    $geoip = json_decode($data, 1);
    $latitude = $geoip['latitude'];
    $longitude = $geoip['longitude'];
  }
  $query = db_merge('scratchpads_statistics_user')->key(array(
    'email' => $account->mail
  ))->fields(array(
    'name' => $name,
    'email' => $account->mail,
    'country' => $country,
    'latitude' => $latitude,
    'longitude' => $longitude
  ))->execute();
}

/**
 * Implements hook_query_TAG_alter().
 */
function scratchpads_statistics_query_scratchpads_statistics_alter(QueryAlterableInterface $query){
  // If we're here, we should have one table, and possibly one field.  We look
  // through each of the fields for the "entity_id" field, and this is then used
  // to left-join to the field_taxonomic_name table. 
  foreach($query->getTables() as $table){
    // Add all the fields.
    $query->fields($table['alias']);
    // Join to the field_data_field_taxonomic_name table to allow us to count
    // terms.
    foreach($query->getFields() as $field){
      if($field['alias'] == 'entity_id'){
        break;
      }
    }
    // Join to the field taxonomic name table.
    $query->leftJoin('field_data_field_taxonomic_name', 'f', "f.entity_id = {$table['alias']}.{$field['field']}");
    $query->fields('f', array(
      'field_taxonomic_name_tid'
    ));
    $query->leftJoin('taxonomy_term_data', 't', 't.tid = f.field_taxonomic_name_tid');
    $query->leftJoin('scratchpads_statistics_term', 'sst', 'sst.term LIKE t.name');
    $query->addField('sst', 'id', 'ss_term_id');
    // Join to the scratchpads_statistics_user table via the user table.
    $query->innerJoin('users', 'u', "u.uid = {$table['alias']}.uid");
    $query->innerJoin('scratchpads_statistics_user', 'ssu', 'ssu.email = u.mail');
    $query->addField('ssu', 'id', 'ss_user_id');
    if($table['table'] == 'node'){
      // Join to the counter table, allowing it to not include a count for all
      // nodes.
      $query->leftJoin('node_counter', 'nc', "nc.nid = {$table['alias']}.nid");
      $query->fields('nc', array(
        'totalcount'
      ));
      // Join to the revisions table.
      // FIXME this should work with all entities that support revisions (e.g.
      // the character project).
      $query->innerJoin('node_revision', 'nr', "nr.nid = {$table['alias']}.nid");
      $query->addField('nr', 'uid', 'revision_uid');
      // Join to the scratchpads_statistics_user table again, but for the revision
      // user
      $query->innerJoin('users', 'ru', 'ru.uid = nr.uid');
      $query->innerJoin('scratchpads_statistics_user', 'ssu_r', 'ssu_r.email = ru.mail');
      $query->addField('ssu_r', 'id', 'ss_revision_user_id');
    }
  }
}

/**
 * Basic function that seems to be missing to deliver JSON to the browser or to
 * another service.
 * 
 * Based on ajax_delver (see documentation there).
 */
function json_deliver($json){
  if($json == MENU_ACCESS_DENIED){
    $json = array(
      'ACCESS DENIED'
    );
  }
  $iframe_upload = !empty($_POST['ajax_iframe_upload']);
  if(is_null(drupal_get_http_header('Content-Type'))){
    if(!$iframe_upload){
      drupal_add_http_header('Content-Type', 'application/json; charset=utf-8');
    }else{
      drupal_add_http_header('Content-Type', 'text/html; charset=utf-8');
    }
  }
  drupal_alter('json', $json);
  $json = drupal_json_encode($json);
  if(!$iframe_upload){
    print $json;
  }else{
    print '<textarea>' . $json . '</textarea>';
  }
  ajax_footer();
}

/**
 * Implements hook_permission().
 */
function scratchpads_statistics_permission(){
  return array(
    'administer scratchpads statistics' => array(
      'title' => t('Administer scratchpads statistics')
    )
  );
}

/**
 * Access callback for the JSON page.
 */
function scratchpads_statistics_access(){
  // We allow access from Quartz and from localhost.  Anybody else must
  // authenticate using a hash.
  if(in_array($_SERVER['REMOTE_ADDR'], array(
    '127.0.0.1',
    '157.140.2.32',
    '157.140.127.252'
  )) || (isset($_GET['hash']) && md5($_GET['hash']) == variable_get('scratchpads_statistics_hash', uniqid(NULL, TRUE)))){return TRUE;}
  return FALSE;
}